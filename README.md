# Attraktor Wiki

MediaWiki instance for Attraktor e.V.
<https://wiki.attraktor.org/Attraktor_Wiki>
<https://www.mediawiki.org/wiki/Version_lifecycle>

## Upgrading to new MediaWiki Version

Please refer to the [UPGRADE.md](./docs/UPGRADE.md) document for detailed upgrade instructions.

## Local Development with Docker Compose

Please refer to the [LOCAL.md](./docs/LOCAL.md) document for detailed instructions on setting up a local development environment.

## Coolify Deployment

### Create New Application

1. Login to coolify.
2. Pick or create a Project (e.g. `Wiki`).
3. choose an environment (e.g. `Production`).
4. create a new application from `Private Git Repository`.
5. select github application (is used for deployment).
6. pick the `attraktorwiki` repository.
7. fill out the settings as follows:
    - Branch: `REL1_43` (or any other branch you want to deploy)
    - Build Pack: `Docker Compose`
    - Base Directory: `/`
    - Docker Compose Location: `/compose.coolify.yaml`

### Configuration

#### General

- General
  - Name: `Attraktor Wiki`
  - Description: `MediaWiki instance for Attraktor e.V.`
  - Build Pack: `Docker Compose`
- Domains
  - Domains for mediawiki: `https://wiki.attraktor.org`
- Build
  - Base Directory: `/`
  - Docker Compose Location: `/compose.coolify.yaml`
- Pre/Post Deployment Commands
- Post-deployment for Container: `mediawiki`:

    ```shell
    sleep 10s && php maintenance/run.php update --quick && php maintenance/run.php runJobs
    ```

#### Environment Variables

> [!WARNING]
> Autogenerated environment variables (like passwords) will only be generated on first deployment.

> [!CAUTION]
> MariaDB will not update the local user password on subsequent deployments. if you change this you have to update the mariaDB user password manually from inside the container.

- All locally needed passwords and secrets will be autogenerated by Coolify, only change them if you are sure.
- Fill out missing environment variables (marked in red) e.g. SMTP settings

#### Scheduled Tasks

- ToDo: add backups of database and images here
- Add Backup Job for Database (e.g. daily at 2am)
  - Name: `Database Backup`
  - Frequency: `daily`
  - Command:

    ```shell
    mariadb-dump -u ${MYSQL_USER} -p${SERVICE_PASSWORD_DBUSERPW} --default-character-set=binary --single-transaction ${MYSQL_DATABASE} | gzip > /mnt/backups/${MYSQL_DATABASE}_$(date +%Y%m%d).sql.gz
    ```

- Add Backup Job for Images (e.g. monthly at 2am)
  - Name: `Images Backup`
  - Frequency: `monthly`
  - Command:

    ```shell
    tar -czf /mnt/backups/images_$(date +%Y%m%d).tar.gz /var/www/html/images
    ```

### First time Setup (Or Restore from Backup)

- Once everything is configured click `Deploy` in the top right corner to start the first deployment.

> [!NOTE]
> The first deployment will throw errors because the database is empty. This is expected.

- Copy database backup and images to Coolify server's shared storage, e.g. to `/mnt/shared/` mounted in both mariadb and mediawiki containers.
  - use `scp` or similar tool to transfer files via commandline.
  - or use `zipline` or `filebrowser` container in Coolify to upload files via web interface.
  - then move/copy files to `/mnt/shared/` folder using host terminal.
- restore database (run inside mariadb container)

   ```shell
   gunzip < /mnt/shared/attraktorwiki.REL1_43.sql.gz | mariadb -u ${MYSQL_USER} -p${MYSQL_PASSWORD} ${MYSQL_DATABASE}
   ```

- restore images (run inside mediawiki container)

   ```shell
   tar -xvzf /mnt/shared/attraktorwiki.images.tar.gz -C /var/www/html/ && \
   chown -R www-data:www-data /var/www/html/images
   ```

- update MediaWiki and run jobs (run inside mediawiki container)

   ```shell
   php maintenance/run.php update --quick && \
   php maintenance/run.php runJobs
   ```

## Add Extensions

- Extensions hosted on packagist can be added via composer. Multiple options:
  - Run inside mediawiki container (will be lost on container rebuild):

    ```shell
    COMPOSER=composer.local.json composer require mediawiki/<extension-name> --no-update
    ```

  - Add them to `./configs/composer.local.json` file locally and rebuild container:
    - Either by just adding them manually to the `require` section of the json file
    - Or by running the following command locally to add them to the local file (with proper version and dependencies):

      ```shell
      docker compose exec mediawiki bash -lc 'COMPOSER=composer.local.json composer require mediawiki/<extension-name> --no-update'
      ```

  - In both cases, after modifying `composer.local.json`, rebuild the mediawiki container to apply changes:

    ```shell
    docker compose up -d --build mediawiki
    ```

- Extensions not hosted on packagist have to be added to the DOCKERFILE as git clone commands.
