# Attraktor Wiki

MediaWiki instance for Attraktor e.V.

<https://wiki.attraktor.org/Attraktor_Wiki>

<https://www.mediawiki.org/wiki/Version_lifecycle>

## Upgrading to new MediaWiki Version

Please refer to the [UPGRADE.md](./docs/UPGRADE.md) document for detailed upgrade instructions.

## Local Development with Docker Compose

Please refer to the [LOCAL.md](./docs/LOCAL.md) document for detailed instructions on setting up a local development environment.

## Coolify Deployment

### Create New Application

1. Login to coolify.
2. Pick or create a Project (e.g. `Wiki`).
3. choose an environment (e.g. `Production`).
4. create a new application from `Private Git Repository`.
5. select github application (is used for deployment).
6. pick the `attraktorwiki` repository.
7. fill out the settings as follows:
    - Branch: `REL1_43` (or any other branch you want to deploy)
    - Build Pack: `Docker Compose`
    - Base Directory: `/`
    - Docker Compose Location: `/compose.coolify.yaml`

### Configuration

#### General

- General
  - Name: `Attraktor Wiki`
  - Description: `MediaWiki instance for Attraktor e.V.`
  - Build Pack: `Docker Compose`
- Domains
  - Domains for mediawiki: `https://wiki.attraktor.org`
- Build
  - Base Directory: `/`
  - Docker Compose Location: `/compose.coolify.yaml`
- Pre/Post Deployment Commands
- Post-deployment for Container: `mediawiki`:

    ```shell
    post_deployment.sh
    ```

#### Environment Variables

> [!WARNING]
> Autogenerated environment variables (like passwords) will only be generated on first deployment.

> [!CAUTION]
> MariaDB will not update the local user password on subsequent deployments. if you change this you have to update the mariaDB user password manually from inside the container.

- All locally needed passwords and secrets will be autogenerated by Coolify, only change them if you are sure.
- Fill out missing environment variables (marked in red) e.g. SMTP settings

#### Scheduled Tasks

- Add Backup Job for Database (e.g. daily at 2am)
  - Name: `Database Backup`
  - Frequency: `daily`
  - Container: `mariadb`
  - Command:

    ```shell
    backup_db.sh
    ```

- Add Backup Job for Images (e.g. monthly at 2am)
  - Name: `Images Backup`
  - Frequency: `monthly`
  - Container: `mediawiki`
  - Command:

    ```shell
    backup_images.sh
    ```

- Backups will be synced with S3 Bucket via Duplicati container in Coolify.

### First time Setup (Or Restore from Backup)

- Once everything is configured click `Deploy` in the top right corner to start the first deployment.

> [!NOTE]
> The first deployment will throw errors because the database is empty. This is expected.

- Copy database backup and images to Coolify server's backup storage, e.g. to `/mnt/backups/attraktorwiki/` mounted in mediawiki container. (several options to do this):
  - use `duplicati` to restore from S3 backup. (preferred!)
  - use `scp` or similar tool to transfer files via commandline.
  - or use `zipline` or `filebrowser` container in Coolify to upload files via web interface.
  - then move/copy files to `/mnt/backups/attraktorwiki/` folder using host terminal.
- run commands in mediawiki container to restore database and images from backup files:

  ```shell
  restore_db.sh

  restore_images.sh

  post_deployment.sh
  ```

> [!NOTE]
> all the above scripts are located in `/usr/local/bin/` inside the container so you can run them from anywhere without specifying the full path.

## Add Extensions (try out on local setup first!)

- Extensions hosted on packagist can be added via composer. Multiple options:
  - Run inside mediawiki container (will be lost on container rebuild):

    ```shell
    COMPOSER=composer.local.json composer require mediawiki/<extension-name> --no-update
    ```

  - Add them to `./configs/composer.local.json` file locally and rebuild container:
    - Either by just adding them manually to the `require` section of the json file
    - Or by running the following command locally to add them to the local file (with proper version and dependencies):

      ```shell
      docker compose exec mediawiki bash -lc 'COMPOSER=composer.local.json composer require mediawiki/<extension-name> --no-update'
      ```

  - In both cases, after modifying `composer.local.json`, rebuild the mediawiki container to apply changes:

    ```shell
    docker compose up -d --build mediawiki
    ```

- Extensions not hosted on packagist have to be added to the DOCKERFILE as git clone commands.
