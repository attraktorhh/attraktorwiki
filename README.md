# attraktorwiki

## First time setup

### Prerequisites

- Database dump in `./backup/` compatible with MediaWiki 1.43 (e.g. `attraktorwiki.REL1_43.sql.gz`)
- Backup of `images/` in `./backup/` (or directly in `./images/` from previous installation)

### Run Locally with Docker Compose

1. Copy `.env.dist` to `.env` and adjust environment variables as needed.

   ```shell
   cp .env.dist .env
   ```

2. Build and start the containers:

   ```shell
   docker compose up -d --build
   ```

3. import database dump from backup file in `./backup/` folder:

   ```shell
   source '.env' && gunzip < ./backup/attraktorwiki.REL1_43.sql.gz | docker compose exec -T mariadb mariadb -u attraktorwiki -p${SERVICE_PASSWORD_DBUSERPW} attraktorwiki
   ```

4. Import images from backup files in `./backup/` folder and set proper permissions:

   - If images are in `./backup/images/`:

     ```shell
     docker compose cp ./backup/images/. mediawiki:/var/www/html/images/
     ```

   - in any case, set proper ownership:

      ```shell
      docker compose exec mediawiki chown -R www-data:www-data /var/www/html/images
      ```

5. Run MediaWiki update script:

   ```shell
   docker compose exec mediawiki php maintenance/run.php update --quick
   ```

6. Run pending Jobs:

   ```shell
   docker compose exec mediawiki php maintenance/run.php runJobs
   ```

7. Access the wiki at <http://localhost:8080>

### Deploy to Coolify

#### Coolify

- Configuration
  - General
    - Name: `attraktorwiki`
    - Build Pack: `Docker Compose`
  - Domains
    - Domains for mediawiki: `wiki.attraktor.org`
  - Build
    - Base Directory: `/`
    - Docker Compose Location: `/compose.coolify.yaml`
  - Pre/Post Deployment Commands
  - Post-deployment for Container: `mediawiki`:

      ```shell
      php maintenance/run.php update --quick && php maintenance/run.php runJobs
      ```

- Environment Variables
  - All locally needed passwords and secrets will be autogenerated by Coolify, only change them if you are sure.
    > [!WARNING]
    > Autogenerated environment variables (like passwords) will only be generated on first deployment.
  - Fill out missing environment variables (marked in red) e.g. SMTP settings
    > [!CAUTION]
    > MariaDB will not update the local user password on subsequent deployments. if you change this you have to update the mariaDB user password manually from inside the container.
- Scheduled Tasks
  - ToDo: add backups of database and images here

#### Manual steps for first time setup

- Copy database backup and images to Coolify server's shared storage, e.g. to `/mnt/shared/` mounted in both mariadb and mediawiki containers.
  - use `scp` or similar tool to transfer files via commandline.
  - or use `zipline` or `filebrowser` container in Coolify to upload files via web interface.
- restore database (run inside mariadb container)

   ```shell
   gunzip < /mnt/shared/attraktorwiki.REL1_43.sql.gz | mariadb -u ${MYSQL_USER} -p${MYSQL_PASSWORD} ${MYSQL_DATABASE}
   ```

- restore images (run inside mediawiki container)

   ```shell
   tar -xvzf /mnt/shared/attraktorwiki.images.tar.gz -C /var/www/html/images && \
   chown -R www-data:www-data /var/www/html/images
   ```

- update MediaWiki and run jobs (run inside mediawiki container)

   ```shell
   php maintenance/run.php update --quick && \
   php maintenance/run.php runJobs
   ```

## Add Extensions

- ToDo
