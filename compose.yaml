name: attraktorwiki

configs:
  mediawiki_secrets:
    content: |
      <?php
      $$wgSecretKey   = "${MEDIAWIKI_SECRET_KEY}";
      $$wgServer      = "${COOLIFY_URL}";
      $$wgFQDN        = "${COOLIFY_FQDN}";
      $$wgDBtype      = "mysql";
      $$wgDBserver    = "${SERVICE_NAME_MARIADB}";
      $$wgDBname      = "${MYSQL_DATABASE}";
      $$wgDBuser      = "${MYSQL_USER}";
      $$wgDBpassword  = "${MYSQL_PASSWORD}";
      // $$wgSMTP = [
      //     'host'      => "${SMTP_HOST}",
      //     'IDHost'    => "${SMTP_IDHOST}",
      //     'port'      => ${SMTP_PORT},
      //     'auth'      => true,
      //     'username'  => "${SMTP_USERNAME}",
      //     'password'  => "${SMTP_PASSWORD}"
      // ];
      
services:
  mariadb:
    image: mariadb:lts
    container_name: attr_mariadb
    restart: unless-stopped
    environment:
      - MYSQL_DATABASE
      - MYSQL_USER
      - MYSQL_PASSWORD
      - MYSQL_ROOT_PASSWORD
    volumes:
      - mediawikidb-mysql:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 3

  mediawiki:
    build: .
    container_name: attr_mediawiki
    restart: unless-stopped
    depends_on:
      - mariadb
    environment:
      - SERVICE_URL_MEDIAWIKI_80
    configs:
      - source: mediawiki_secrets
        target: /var/www/data/LocalSecrets.php
    volumes:
      - 'mediawiki-images:/var/www/html/images'
      - 'mediawiki-composer-cache:/var/www/html/.composer/cache'
      # - ./skins/attraktor:/var/www/html/skins/attraktor
      # - ./composer.local.json:/var/www/html/composer.local.json
      # - ./LocalSettings.php:/var/www/html/LocalSettings.php
    healthcheck:
      test:
        - CMD
        - curl
        - '-f'
        - 'http://localhost:80'
      interval: 5s
      timeout: 20s
      retries: 10

volumes:
  mediawiki-images:
  mediawikidb-mysql:
  mediawiki-composer-cache:

networks:
  default:
    driver: bridge
